<link rel="import" href="../polymer/polymer-element.html">
<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">

<dom-module id="country-select">
  <template>
    <style>
    :host {
      display: block;
    }
    </style>

    <paper-dropdown-menu label="[[label]]">
      <paper-listbox class="dropdown-content"
        slot="dropdown-content"
        attr-for-selected="code"
        selected="{{selectedCountry}}">
        <template is="dom-repeat" items="[[_countries]]">
          <paper-item code="[[item.code]]">[[item.name]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

  </template>

  <script>
    (function() {
      window.Protoss78 = window.Protoss78 || {};

      window.Protoss78.compareBy = (prop) =>
        (o1, o2) => o1[prop].localeCompare(o2[prop]);

      /**
       * `country-select`
       *
       * A simple country selector web component using the paper-dropdown-menu
       * that implements the app-localize-behavior and can translate the country
       * names. Currently it supports localized country names for 253 languages.
       * The country list is based on
       * [umpirsky/country-list](https://github.com/umpirsky/country-list).
       *
       * @summary A simple country selector.
       * @polymer
       * @customElement
       * @memberof Protoss78
       * @demo demo/index.html
       */
      class CountrySelect extends Polymer.mixinBehaviors(
        [Polymer.AppLocalizeBehavior],
        Polymer.Element) {

        static get is() {
          return 'country-select';
        }

        static get properties() {
          return {
            /**
             * The label to be displayed in the dropdown menu.
             *
             * @attribute label
             * @type String
             * @default 'Country'
             */
            label: {
              type: String,
              value: 'Country',
            },
            /**
             * The currently selected country. The country is represented by its
             * [ISO 3166-1 alpha-2 code](https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2).
             *
             * @attribute selectedCountry
             * @type String
             */
            selectedCountry: {
              type: String,
              notify: true,
            },
            /**
             * The language code that is used to display the country names. It
             * is represented using a "locale code" defined in
             * [BCP 47](https://tools.ietf.org/html/bcp47).
             *
             * @attribute language
             * @type String
             * @default 'en'
             */
            language: {
              type: String,
              value: 'en',
            },
            _countries: {
              type: Array,
              readOnly: true,
            },
          };
        }

        static get observers() {
          return [
            '_onLanguageChanged(language)',
          ];
        }

        ready() {
          super.ready();
          this.addEventListener('app-localize-resources-loaded', this._onTranslationLoaded);
        }

        _onLanguageChanged(lang) {
          if (lang) {
            const path = this.resolveUrl(`../country-list/data/${lang.replace('-', '_')}/country.json`);
            this.loadResources(path, lang, true);
          }
        }

        _onTranslationLoaded() {
          const values = this.resources[this.language.replace('_', '-')];
          const countries = Object.keys(values)
            .map((key) => Object.assign({}, {
              code: key,
              name: values[key],
            }))
            .sort(window.Protoss78.compareBy('name'));
          this._set_countries(countries);
        }

      }

      window.customElements.define(CountrySelect.is, CountrySelect);

      /**
       * @namespace Protoss78
       */
      window.Protoss78.CountrySelect = CountrySelect;
    })();
  </script>
</dom-module>
